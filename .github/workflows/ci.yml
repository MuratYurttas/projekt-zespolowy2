name: build_and_test   # 🔹 Workflow'un ismi (GitHub Actions sekmesinde bu görünür)

on:                    # 🔹 Ne zaman çalışacağını belirler
  push:                # Her 'push' olayında
    branches: [ "main" ]   # Sadece 'main' branch'e push yapıldığında

jobs:                  # 🔹 Çalışacak işler (birden fazla olabilir)
  test:                # Burada bir 'test' işi tanımlıyoruz
    runs-on: ubuntu-latest   # GitHub'un çalıştıracağı sanal sistem (Ubuntu)

    steps:             # Adım adım yapılacaklar
      - uses: actions/checkout@v4   # 1️⃣ Reponun kodunu indir

      - name: Setup PHP            # 2️⃣ PHP kur
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'

     - name: Start PHP server
  run: php -S 127.0.0.1:8000 -t public >/dev/null 2>&1 &



      - name: Make tests executable # 4️⃣ Test dosyasını çalıştırılabilir hale getir
        run: chmod +x tests/integration.sh

      - name: Run integration tests # 5️⃣ Testleri çalıştır
        env:
          BASE: http://127.0.0.1:8000
        run: ./tests/integration.sh

  deploy:               # 🔹 (Opsiyonel) Deploy işi
    needs: test         # 🔹 Sadece testler başarılı olursa çalışır
    if: success()
    runs-on: ubuntu-latest
    steps:
      - name: Trigger deploy (optional)
        env:
          HOOK: ${{ secrets.DEPLOY_HOOK_URL }}
        run: |
          if [ -n "$HOOK" ]; then
            curl -X POST "$HOOK"
          else
            echo "No deploy hook configured. Skipping deploy."
          fi
